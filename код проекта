import yfinance as yf
import logging
import io
import matplotlib.pyplot as plt
from datetime import datetime
from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    ReplyKeyboardMarkup,
    ReplyKeyboardRemove
)
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
    MessageHandler,
    filters
)
import pandas as pd
import numpy as np

# ==================== Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº ====================
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ==================== ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ÑĞ·Ñ‹Ñ‡Ğ½Ğ¾ÑÑ‚Ğ¸ ====================
LANGUAGES = {
    "en": {
        "welcome": "ğŸ“ˆ Stock Dividend Bot\nType /help for commands",
        "no_args": "Please enter a stock symbol, e.g.: /dividend AAPL",
        "fetching": "Fetching {symbol} data...",
        "no_data": "{symbol} has no dividend data",
        "dividend_info": "ğŸ¦ Company: {name}\nğŸ’° Price: {price}\nğŸ“ˆ Yield: {yield_pct}%\n\nRecent dividends:",
        "chart_btn": "View Chart",
        "error": "Data fetch failed",
        "lang_set": "Language set to English",
        "choose_lang": "Choose language:",
        "portfolio_empty": "Your portfolio is empty",
        "portfolio_header": "ğŸ“Š Your Portfolio:\n",
        "lesson_menu": "Choose a lesson:",
        "risk_info": "ğŸ“Š {symbol} Risk\nVolatility: {volatility:.2%}\nRisk: {risk_level}",
        "help_text": """ğŸ“š <b>Help</b>

<u>Core</u>
/start - Show welcome
/help - This guide
/language - Change language
/dividend &lt;symbol&gt; - Dividend info

<u>Portfolio</u>
/add &lt;symbol&gt; - Add stock
/portfolio - View portfolio

<u>Analysis</u>
/risk &lt;symbol&gt; - Risk analysis

<u>Education</u>
/learn - Investment lessons""",
        "help_portfolio": "ğŸ“¦ <b>Portfolio Help</b>\n\n/add to add stocks\n/portfolio to view",
        "help_risk": "âš ï¸ <b>Risk Help</b>\n\n/risk calculates stock volatility",
        "help_dividend": "ğŸ’° <b>Dividend Help</b>\n\n/dividend shows last 4 payments"
    },
    "zh": {
        "welcome": "ğŸ“ˆ è‚¡ç¥¨è‚¡æ¯æœºå™¨äºº\nè¾“å…¥ /help æŸ¥çœ‹å‘½ä»¤",
        "no_args": "è¯·è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œä¾‹å¦‚: /dividend AAPL",
        "fetching": "æ­£åœ¨è·å– {symbol} æ•°æ®...",
        "no_data": "{symbol} æ— è‚¡æ¯æ•°æ®",
        "dividend_info": "ğŸ¦ å…¬å¸: {name}\nğŸ’° è‚¡ä»·: {price}\nğŸ“ˆ è‚¡æ¯ç‡: {yield_pct}%\n\næœ€è¿‘è‚¡æ¯:",
        "chart_btn": "æŸ¥çœ‹å›¾è¡¨",
        "error": "è·å–æ•°æ®å¤±è´¥",
        "lang_set": "è¯­è¨€å·²è®¾ç½®ä¸ºä¸­æ–‡",
        "choose_lang": "é€‰æ‹©è¯­è¨€:",
        "portfolio_empty": "æŠ•èµ„ç»„åˆä¸ºç©º",
        "portfolio_header": "ğŸ“Š æ‚¨çš„ç»„åˆ:\n",
        "lesson_menu": "é€‰æ‹©è¯¾ç¨‹:",
        "risk_info": "ğŸ“Š {symbol} é£é™©\næ³¢åŠ¨ç‡: {volatility:.2%}\né£é™©ç­‰çº§: {risk_level}",
        "help_text": """ğŸ“š <b>å¸®åŠ©</b>

<u>æ ¸å¿ƒ</u>
/start - æ˜¾ç¤ºæ¬¢è¿
/help - æœ¬æŒ‡å—
/language - æ›´æ”¹è¯­è¨€
/dividend &lt;ä»£ç &gt; - è‚¡æ¯ä¿¡æ¯

<u>ç»„åˆ</u>
/add &lt;ä»£ç &gt; - æ·»åŠ è‚¡ç¥¨
/portfolio - æŸ¥çœ‹ç»„åˆ

<u>åˆ†æ</u>
/risk &lt;ä»£ç &gt; - é£é™©åˆ†æ

<u>æ•™è‚²</u>
/learn - æŠ•èµ„è¯¾ç¨‹""",
        "help_portfolio": "ğŸ“¦ <b>ç»„åˆå¸®åŠ©</b>\n\n/add æ·»åŠ è‚¡ç¥¨\n/portfolio æŸ¥çœ‹ç»„åˆ",
        "help_risk": "âš ï¸ <b>é£é™©å¸®åŠ©</b>\n\n/risk è®¡ç®—è‚¡ç¥¨æ³¢åŠ¨ç‡",
        "help_dividend": "ğŸ’° <b>è‚¡æ¯å¸®åŠ©</b>\n\n/dividend æ˜¾ç¤ºæœ€è¿‘4æ¬¡æ”¯ä»˜"
    },
    "es": {
        "welcome": "ğŸ“ˆ Bot de Dividendos\nEscribe /help para ver comandos",
        "no_args": "Ingrese un sÃ­mbolo, ej: /dividend AAPL",
        "fetching": "Obteniendo datos de {symbol}...",
        "no_data": "{symbol} no tiene datos de dividendos",
        "dividend_info": "ğŸ¦ Empresa: {name}\nğŸ’° Precio: {price}\nğŸ“ˆ Rendimiento: {yield_pct}%\n\nDividendos recientes:",
        "chart_btn": "Ver GrÃ¡fico",
        "error": "Error al obtener datos",
        "lang_set": "Idioma cambiado a espaÃ±ol",
        "choose_lang": "Elige idioma:",
        "portfolio_empty": "Tu portfolio estÃ¡ vacÃ­o",
        "portfolio_header": "ğŸ“Š Tu Portfolio:\n",
        "lesson_menu": "Elige una lecciÃ³n:",
        "risk_info": "ğŸ“Š Riesgo de {symbol}\nVolatilidad: {volatility:.2%}\nNivel: {risk_level}",
        "help_text": """ğŸ“š <b>Ayuda</b>

<u>BÃ¡sico</u>
/start - Mostrar bienvenida
/help - Esta guÃ­a
/language - Cambiar idioma
/dividend &lt;sÃ­mbolo&gt; - Info de dividendos

<u>Portfolio</u>
/add &lt;sÃ­mbolo&gt; - AÃ±adir acciÃ³n
/portfolio - Ver portfolio

<u>AnÃ¡lisis</u>
/risk &lt;sÃ­mbolo&gt; - AnÃ¡lisis de riesgo

<u>EducaciÃ³n</u>
/learn - Lecciones de inversiÃ³n""",
        "help_portfolio": "ğŸ“¦ <b>Ayuda Portfolio</b>\n\n/add para aÃ±adir\n/portfolio para ver",
        "help_risk": "âš ï¸ <b>Ayuda Riesgo</b>\n\n/risk calcula volatilidad",
        "help_dividend": "ğŸ’° <b>Ayuda Dividendos</b>\n\n/dividend muestra Ãºltimos 4 pagos"
    },
    "ru": {
        "welcome": "ğŸ“ˆ Ğ‘Ğ¾Ñ‚ Ğ´Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´Ğ¾Ğ²\nĞĞ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ /help Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´",
        "no_args": "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚Ğ¸ĞºĞµÑ€, Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: /dividend AAPL",
        "fetching": "ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… {symbol}...",
        "no_data": "{symbol} Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¾ Ğ´Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´Ğ°Ñ…",
        "dividend_info": "ğŸ¦ ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ: {name}\nğŸ’° Ğ¦ĞµĞ½Ğ°: {price}\nğŸ“ˆ Ğ”Ğ¾Ñ…Ğ¾Ğ´Ğ½Ğ¾ÑÑ‚ÑŒ: {yield_pct}%\n\nĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ Ğ´Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´Ñ‹:",
        "chart_btn": "Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº",
        "error": "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…",
        "lang_set": "Ğ¯Ğ·Ñ‹Ğº Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½ Ğ½Ğ° Ñ€ÑƒÑÑĞºĞ¸Ğ¹",
        "choose_lang": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ·Ñ‹Ğº:",
        "portfolio_empty": "Ğ’Ğ°Ñˆ Ğ¿Ğ¾Ñ€Ñ‚Ñ„ĞµĞ»ÑŒ Ğ¿ÑƒÑÑ‚",
        "portfolio_header": "ğŸ“Š Ğ’Ğ°Ñˆ Ğ¿Ğ¾Ñ€Ñ‚Ñ„ĞµĞ»ÑŒ:\n",
        "lesson_menu": "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑƒÑ€Ğ¾Ğº:",
        "risk_info": "ğŸ“Š Ğ Ğ¸ÑĞº {symbol}\nĞ’Ğ¾Ğ»Ğ°Ñ‚Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: {volatility:.2%}\nĞ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ: {risk_level}",
        "help_text": """ğŸ“š <b>ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ</b>

<u>ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ</u>
/start - ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ
/help - Ğ­Ñ‚Ğ° ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ°
/language - Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑĞ·Ñ‹Ğº
/dividend &lt;Ñ‚Ğ¸ĞºĞµÑ€&gt; - Ğ˜Ğ½Ñ„Ğ¾ Ğ¾ Ğ´Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´Ğ°Ñ…

<u>ĞŸĞ¾Ñ€Ñ‚Ñ„ĞµĞ»ÑŒ</u>
/add &lt;Ñ‚Ğ¸ĞºĞµÑ€&gt; - Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°ĞºÑ†Ğ¸Ñ
/portfolio - ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ñ€Ñ‚Ñ„ĞµĞ»ÑŒ

<u>ĞĞ½Ğ°Ğ»Ğ¸Ğ·</u>
/risk &lt;Ñ‚Ğ¸ĞºĞµÑ€&gt; - ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ€Ğ¸ÑĞºĞ°

<u>ĞĞ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ</u>
/learn - Ğ£Ñ€Ğ¾ĞºĞ¸ Ğ¸Ğ½Ğ²ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ""",
        "help_portfolio": "ğŸ“¦ <b>ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ¿Ğ¾ Ğ¿Ğ¾Ñ€Ñ‚Ñ„ĞµĞ»Ñ</b>\n\n/add Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ\n/portfolio Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€",
        "help_risk": "âš ï¸ <b>ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ¿Ğ¾ Ñ€Ğ¸ÑĞºÑƒ</b>\n\n/risk Ñ€Ğ°ÑÑ‡ĞµÑ‚ Ğ²Ğ¾Ğ»Ğ°Ñ‚Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸",
        "help_dividend": "ğŸ’° <b>ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ¿Ğ¾ Ğ´Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´Ğ°Ğ¼</b>\n\n/dividend Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 4 Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ñ‹"
    }
}

# ==================== Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ====================
user_data = {}  # {user_id: {'language': 'en', 'portfolio': []}}

# ==================== ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ ====================
LESSONS = {
    1: {
        "title": {
            "en": "ğŸ“š Lesson 1: Dividends Basics",
            "zh": "ğŸ“š ç¬¬ä¸€è¯¾: è‚¡æ¯åŸºç¡€",
            "es": "ğŸ“š LecciÃ³n 1: Conceptos bÃ¡sicos",
            "ru": "ğŸ“š Ğ£Ñ€Ğ¾Ğº 1: ĞÑĞ½Ğ¾Ğ²Ñ‹ Ğ´Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´Ğ¾Ğ²"
        },
        "content": {
            "en": "Dividends are company profit distributions...",
            "zh": "è‚¡æ¯æ˜¯å…¬å¸åˆ©æ¶¦åˆ†é…...",
            "es": "Los dividendos son distribuciones de ganancias...",
            "ru": "Ğ”Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´Ñ‹ - ÑÑ‚Ğ¾ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ğ»Ğ¸..."
        }
    },
    2: {
        "title": {
            "en": "ğŸ“ˆ Lesson 2: Dividend Safety",
            "zh": "ğŸ“ˆ ç¬¬äºŒè¯¾: è‚¡æ¯å®‰å…¨æ€§",
            "es": "ğŸ“ˆ LecciÃ³n 2: Seguridad de dividendos",
            "ru": "ğŸ“ˆ Ğ£Ñ€Ğ¾Ğº 2: Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´Ğ¾Ğ²"
        },
        "content": {
            "en": "Assess dividend safety using payout ratios...",
            "zh": "ä½¿ç”¨æ´¾æ¯ç‡è¯„ä¼°è‚¡æ¯å®‰å…¨æ€§...",
            "es": "EvalÃºe la seguridad con ratios de pago...",
            "ru": "ĞÑ†ĞµĞ½Ğ¸Ñ‚Ğµ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· ĞºĞ¾ÑÑ„Ñ„Ğ¸Ñ†Ğ¸ĞµĞ½Ñ‚ Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚..."
        }
    }
}


# ==================== Ğ¯Ğ´Ñ€Ğ¾Ğ²Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ ====================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start"""
    user_id = update.effective_user.id
    lang = user_data.get(user_id, {}).get('language', 'en')
    await update.message.reply_text(LANGUAGES[lang]["welcome"])


async def set_language(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞ·Ñ‹ĞºĞ°"""
    user_id = update.effective_user.id
    lang = user_data.get(user_id, {}).get('language', 'en')

    buttons = [
        ["English", "ä¸­æ–‡"],
        ["EspaÃ±ol", "Ğ ÑƒÑÑĞºĞ¸Ğ¹"]
    ]
    await update.message.reply_text(
        LANGUAGES[lang]["choose_lang"],
        reply_markup=ReplyKeyboardMarkup(buttons, one_time_keyboard=True)
    )


async def handle_language(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ÑĞ·Ñ‹ĞºĞ°"""
    text = update.message.text
    lang_map = {"English": "en", "ä¸­æ–‡": "zh", "EspaÃ±ol": "es", "Ğ ÑƒÑÑĞºĞ¸Ğ¹": "ru"}

    if text in lang_map:
        user_id = update.effective_user.id
        if user_id not in user_data:
            user_data[user_id] = {}
        user_data[user_id]['language'] = lang_map[text]
        await update.message.reply_text(
            LANGUAGES[lang_map[text]]["lang_set"],
            reply_markup=ReplyKeyboardRemove()
        )


# ==================== Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ´Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´Ğ°Ğ¼ ====================
async def dividend(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´Ğ¾Ğ²"""
    user_id = update.effective_user.id
    lang = user_data.get(user_id, {}).get('language', 'en')

    if not context.args:
        await update.message.reply_text(LANGUAGES[lang]["no_args"])
        return

    symbol = context.args[0].upper()
    await update.message.reply_text(LANGUAGES[lang]["fetching"].format(symbol=symbol))

    try:
        stock = yf.Ticker(symbol)
        dividends = stock.dividends

        if dividends.empty:
            await update.message.reply_text(LANGUAGES[lang]["no_data"].format(symbol=symbol))
            return

        info = stock.info
        dividend_yield = round(info.get('dividendYield', 0) * 100, 2)

        message = LANGUAGES[lang]["dividend_info"].format(
            name=info.get('longName', symbol),
            price=info.get('currentPrice', 'N/A'),
            yield_pct=dividend_yield
        )

        for date, amount in dividends.tail(4).items():
            message += f"\nğŸ“… {date.date()}: ${amount:.2f}"

        keyboard = [[
            InlineKeyboardButton(
                LANGUAGES[lang]["chart_btn"],
                callback_data=f"chart_{lang}_{symbol}"
            )
        ]]
        await update.message.reply_text(
            message,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="HTML"
        )

    except Exception as e:
        logger.error(f"Error: {e}")
        await update.message.reply_text(LANGUAGES[lang]["error"])


async def dividend_chart(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ´Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´Ğ¾Ğ²"""
    query = update.callback_query
    await query.answer()

    _, lang, symbol = query.data.split('_')
    stock = yf.Ticker(symbol)

    plt.figure(figsize=(10, 5))
    dividends = stock.dividends
    dividends.plot(kind='bar')
    plt.title(f"{symbol} Dividends")
    plt.ylabel("Amount ($)")
    plt.xticks(rotation=45)

    buf = io.BytesIO()
    plt.savefig(buf, format='png', bbox_inches='tight')
    buf.seek(0)
    plt.close()

    await query.message.reply_photo(
        photo=buf,
        caption=f"{symbol} {LANGUAGES[lang]['chart_btn']}"
    )


# ==================== ĞŸĞ¾Ñ€Ñ‚Ñ„ĞµĞ»ÑŒ ====================
async def add_to_portfolio(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºÑ†Ğ¸Ğ¸"""
    user_id = update.effective_user.id
    lang = user_data.get(user_id, {}).get('language', 'en')

    if not context.args:
        await update.message.reply_text("Usage: /add <symbol>")
        return

    symbol = context.args[0].upper()

    if user_id not in user_data:
        user_data[user_id] = {'portfolio': []}
    elif 'portfolio' not in user_data[user_id]:
        user_data[user_id]['portfolio'] = []

    if symbol not in user_data[user_id]['portfolio']:
        user_data[user_id]['portfolio'].append(symbol)
        await update.message.reply_text(f"âœ… {symbol} added to portfolio")
    else:
        await update.message.reply_text(f"â„¹ï¸ {symbol} already in portfolio")


async def show_portfolio(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ· Ğ¿Ğ¾Ñ€Ñ‚Ñ„ĞµĞ»Ñ"""
    user_id = update.effective_user.id
    lang = user_data.get(user_id, {}).get('language', 'en')

    if user_id not in user_data or 'portfolio' not in user_data[user_id] or not user_data[user_id]['portfolio']:
        await update.message.reply_text(LANGUAGES[lang]["portfolio_empty"])
        return

    message = LANGUAGES[lang]["portfolio_header"]
    total_value = 0

    for symbol in user_data[user_id]['portfolio']:
        try:
            stock = yf.Ticker(symbol)
            price = stock.history(period='1d')['Close'].iloc[-1]
            message += f"\n{symbol}: ${price:.2f}"
            total_value += price
        except Exception as e:
            message += f"\n{symbol}: Error"
            logger.error(f"Price fetch failed: {e}")

    message += f"\n\nğŸ’µ Total: ${total_value:.2f}"
    await update.message.reply_text(message)


# ==================== Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ ====================
async def start_education(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞœĞµĞ½Ñ Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ñ"""
    user_id = update.effective_user.id
    lang = user_data.get(user_id, {}).get('language', 'en')

    keyboard = [
        [InlineKeyboardButton(LESSONS[num]['title'][lang], callback_data=f"lesson_{num}")]
        for num in LESSONS
    ]
    await update.message.reply_text(
        LANGUAGES[lang]["lesson_menu"],
        reply_markup=InlineKeyboardMarkup(keyboard)
    )


async def show_lesson(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑƒÑ€Ğ¾Ğº"""
    query = update.callback_query
    await query.answer()

    lesson_num = int(query.data.split('_')[1])
    user_id = update.effective_user.id
    lang = user_data.get(user_id, {}).get('language', 'en')

    lesson = LESSONS[lesson_num]
    await query.edit_message_text(
        f"{lesson['title'][lang]}\n\n{lesson['content'][lang]}"
    )


# ==================== ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ€Ğ¸ÑĞºĞ¾Ğ² ====================
async def analyze_risk(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ñ€Ğ¸ÑĞºĞ¾Ğ²"""
    user_id = update.effective_user.id
    lang = user_data.get(user_id, {}).get('language', 'en')

    if not context.args:
        await update.message.reply_text("Usage: /risk <symbol>")
        return

    symbol = context.args[0].upper()

    try:
        stock = yf.Ticker(symbol)
        hist = stock.history(period="1y")

        if hist.empty:
            await update.message.reply_text(f"No data for {symbol}")
            return

        returns = hist['Close'].pct_change().dropna()
        volatility = returns.std() * np.sqrt(252)

        if volatility > 0.3:
            risk_level = "High" if lang == "en" else "é«˜é£é™©" if lang == "zh" else "Alto" if lang == "es" else "Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹"
        elif volatility > 0.15:
            risk_level = "Medium" if lang == "en" else "ä¸­ç­‰é£é™©" if lang == "zh" else "Medio" if lang == "es" else "Ğ¡Ñ€ĞµĞ´Ğ½Ğ¸Ğ¹"
        else:
            risk_level = "Low" if lang == "en" else "ä½é£é™©" if lang == "zh" else "Bajo" if lang == "es" else "ĞĞ¸Ğ·ĞºĞ¸Ğ¹"

        await update.message.reply_text(
            LANGUAGES[lang]["risk_info"].format(
                symbol=symbol,
                volatility=volatility,
                risk_level=risk_level
            )
        )

        plt.figure(figsize=(10, 5))
        returns.plot(kind='line', title=f"{symbol} Returns")
        buf = io.BytesIO()
        plt.savefig(buf, format='png')
        buf.seek(0)
        plt.close()
        await update.message.reply_photo(photo=buf)

    except Exception as e:
        logger.error(f"Risk analysis failed: {e}")
        await update.message.reply_text(f"Error: {str(e)}")


# ==================== Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ¸ ====================
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ¸"""
    user_id = update.effective_user.id
    lang = user_data.get(user_id, {}).get('language', 'en')

    keyboard = [
        [InlineKeyboardButton(
            "Portfolio Help" if lang == "en" else
            "ç»„åˆå¸®åŠ©" if lang == "zh" else
            "Ayuda Portfolio" if lang == "es" else
            "ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ¿Ğ¾ Ğ¿Ğ¾Ñ€Ñ‚Ñ„ĞµĞ»Ñ",
            callback_data="help_portfolio")],
        [InlineKeyboardButton(
            "Risk Help" if lang == "en" else
            "é£é™©å¸®åŠ©" if lang == "zh" else
            "Ayuda Riesgo" if lang == "es" else
            "ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ¿Ğ¾ Ñ€Ğ¸ÑĞºÑƒ",
            callback_data="help_risk")],
        [InlineKeyboardButton(
            "Dividend Help" if lang == "en" else
            "è‚¡æ¯å¸®åŠ©" if lang == "zh" else
            "Ayuda Dividendos" if lang == "es" else
            "ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ Ğ¿Ğ¾ Ğ´Ğ¸Ğ²Ğ¸Ğ´ĞµĞ½Ğ´Ğ°Ğ¼",
            callback_data="help_dividend")]
    ]

    await update.message.reply_text(
        LANGUAGES[lang]["help_text"],
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="HTML"
    )


async def help_button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ¸"""
    query = update.callback_query
    await query.answer()

    user_id = update.effective_user.id
    lang = user_data.get(user_id, {}).get('language', 'en')

    help_type = query.data.split("_")[1]
    text = LANGUAGES[lang][f"help_{help_type}"]

    await query.edit_message_text(
        text=text,
        parse_mode="HTML"
    )


# ==================== Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ====================
def main():
    """Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°"""
    application = Application.builder().token("8143486168:AAF5pDrwsSoSHzacJY3HJI9fipjA56ptX0c").build()

    # Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´
    cmd_handlers = [
        CommandHandler("start", start),
        CommandHandler("help", help_command),
        CommandHandler("language", set_language),
        CommandHandler("dividend", dividend),
        CommandHandler("add", add_to_portfolio),
        CommandHandler("portfolio", show_portfolio),
        CommandHandler("learn", start_education),
        CommandHandler("risk", analyze_risk)
    ]
    for handler in cmd_handlers:
        application.add_handler(handler)

    # Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ»Ğ»Ğ±ÑĞºĞ¾Ğ²
    callback_handlers = [
        CallbackQueryHandler(handle_language, pattern="^lang_"),
        CallbackQueryHandler(dividend_chart, pattern="^chart_"),
        CallbackQueryHandler(show_lesson, pattern="^lesson_"),
        CallbackQueryHandler(help_button_handler, pattern="^help_")
    ]
    for handler in callback_handlers:
        application.add_handler(handler)

    # Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
    application.add_handler(MessageHandler(
        filters.TEXT & ~filters.COMMAND,
        handle_language
    ))

    application.run_polling()


if __name__ == '__main__':
    main()
